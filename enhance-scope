#!/usr/bin/env bash

# File containing the commit message
COMMIT_MSG_FILE=$1

# Extract the first line (summary) and remaining lines
read -r COMMIT_SUMMARY <"$COMMIT_MSG_FILE"
COMMIT_BODY=$(tail -n +2 "$COMMIT_MSG_FILE" 2>/dev/null)

# Regex pattern to match commit message format
PATTERN="^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test): .+"

# Get the list of files touched in the commit
FILES_TOUCHED=$(git diff --cached --name-only)

# Count files by counting non-empty lines (matching original logic)
if [ -z "$FILES_TOUCHED" ]; then
	exit 0
fi

FILE_COUNT=$(printf '%s\n' "$FILES_TOUCHED" | grep -c .)

# If the commit doesn't touch exactly one file, exit without modification
if [ "$FILE_COUNT" -ne 1 ]; then
	exit 0
fi

# Get the single filename (remove any trailing newline)
FILENAME="${FILES_TOUCHED%$'\n'}"

# Check if the first line of the commit message matches the allowed pattern
if [[ $COMMIT_SUMMARY =~ $PATTERN ]]; then
	# Check if the filename already appears in the summary
	[[ $COMMIT_SUMMARY == *"$FILENAME"* ]] && exit 0

	# Extract the original type (group 1 in the regex)
	ORIGINAL_TYPE=${BASH_REMATCH[1]}

	# Calculate the modified summary
	PREFIX="$ORIGINAL_TYPE: "
	MODIFIED_SUMMARY="$ORIGINAL_TYPE($FILENAME): ${COMMIT_SUMMARY#"$PREFIX"}"

	# Ensure the modified summary length is less than 51
	if [ ${#MODIFIED_SUMMARY} -lt 51 ]; then
		# Write the modified summary and original body back to the commit message file
		{
			echo "$MODIFIED_SUMMARY"
			[ -n "$COMMIT_BODY" ] && echo "$COMMIT_BODY"
		} >"$COMMIT_MSG_FILE"
		echo "Modified commit message summary: $MODIFIED_SUMMARY" >&2
	fi
fi
