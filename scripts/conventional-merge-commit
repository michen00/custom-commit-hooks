#!/bin/sh
# prepare-commit-msg:
# rewrite auto-generated merge/squash messages to conventional commit format

commit_source=${2-}
[ "$commit_source" = "merge" ] || exit 0

# shellcheck source=lib/commit-msg.sh disable=SC1091
. "$(dirname "$0")/lib/commit-msg.sh"

commit_msg_file="$1"

# Read and parse commit message
read_commit_msg "$commit_msg_file"

# Strip leading whitespace (POSIX parameter expansion)
stripped="${COMMIT_FIRST_LINE#"${COMMIT_FIRST_LINE%%[![:space:]]*}"}"

# Check if matches trigger pattern:
#   ^\s*([Mm]erge[ds]?|[Ss]quash(e[ds])?)[(!:\[]?( .*)?$
# Using case statement to enumerate keyword variants
# Pattern: keyword alone, or keyword followed by space/(/!/:/[
case "$stripped" in
[Mm]erge | [Mm]erge' '* | [Mm]erge\(* | [Mm]erge!* | [Mm]erge:* | [Mm]erge\[*) ;;
[Mm]erged | [Mm]erged' '* | [Mm]erged\(* | [Mm]erged!* | [Mm]erged:* | [Mm]erged\[*) ;;
[Mm]erges | [Mm]erges' '* | [Mm]erges\(* | [Mm]erges!* | [Mm]erges:* | [Mm]erges\[*) ;;
[Ss]quash | [Ss]quash' '* | [Ss]quash\(* | [Ss]quash!* | [Ss]quash:* | [Ss]quash\[*) ;;
[Ss]quashed | [Ss]quashed' '* | [Ss]quashed\(* | [Ss]quashed!* | [Ss]quashed:* | [Ss]quashed\[*) ;;
[Ss]quashes | [Ss]quashes' '* | [Ss]quashes\(* | [Ss]quashes!* | [Ss]quashes:* | [Ss]quashes\[*) ;;
*)
	exit 0
	;;
esac

# Transform: "chore: " + lowercase first char + rest
first_char="${stripped%"${stripped#?}"}"
rest="${stripped#?}"

case "$first_char" in
[Mm]) new_first_line="chore: m$rest" ;;
*) new_first_line="chore: s$rest" ;; # Default: S/s (squash)
esac

write_commit_msg "$commit_msg_file" "$new_first_line" "$COMMIT_REST"
