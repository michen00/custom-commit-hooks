---
name: pre-commit autoupdate
on:
  schedule:
    - cron: "0 0 * * 1" # Run every Monday at 00:00
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: pre-commit-autoupdate
  cancel-in-progress: true

env:
  BRANCH_NAME: chore/pre-commit-autoupdate-workflow

jobs:
  pre-commit-autoupdate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          check-latest: true
          cache: pip
      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          python -m pip install pre-commit
      - name: Cache pre-commit hooks
        id: cache-pre-commit
        uses: actions/cache@v5
        env:
          CACHE_NUMBER: 0
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-precommit-${{ hashFiles('.pre-commit-config.yaml') }}-${{ env.CACHE_NUMBER }} # yamllint disable-line rule:line-length
      - name: Install pre-commit hooks
        if: steps.cache-pre-commit.outputs.cache-hit != 'true'
        run: |
          pre-commit install
      - name: Update pre-commit hooks
        id: autoupdate-pre-commit
        run: |
          OUTPUT=$(pre-commit autoupdate || echo 'autoupdate failed')
          echo "$OUTPUT"
          if [[ "$OUTPUT" == *"No updates available"* ]]; then
            exit 0
          fi
      - name: Test updated pre-commit hooks
        run: |
          if ! pre-commit run --all-files; then
            echo 'Pre-commit hooks failed. Please review the log for details.' >&2
            exit 1
          fi
      - name: Push changes and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet .pre-commit-config.yaml; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # Switch to branch, create if it doesn't exist
          git fetch origin "${{ env.BRANCH_NAME }}" || true
          if git show-ref --verify --quiet refs/heads/"${{ env.BRANCH_NAME }}"; then
            git switch "${{ env.BRANCH_NAME }}"
          else
            git switch -c "${{ env.BRANCH_NAME }}"
          fi

          git add .pre-commit-config.yaml
          git commit -m 'chore(pre-commit): bump hook versions' -s
          git push -u origin "${{ env.BRANCH_NAME }}" --force-with-lease

          pr_state=$(gh pr view "${{ env.BRANCH_NAME }}" --state all --json state --jq '.state' 2>/dev/null || echo "MISSING")
          if [ "$pr_state" = "OPEN" ]; then
            echo "PR already exists for branch ${{ env.BRANCH_NAME }}"
            exit 0
          fi
          gh pr create \
            --base main \
            --head "${{ env.BRANCH_NAME }}" \
            --title 'chore: autoupdate pre-commit hooks' \
            --body 'This PR updates pre-commit hooks to their latest versions.'
